<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffbfd6">
    <meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>our secret thing</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* --- CORE RESET & VARS --- */
        :root {
            --font-main: 'Varela Round', sans-serif;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
            --app-height: 100vh;
        }

        /* THEME DEFINITIONS */
        [data-theme="sanrio"] { --bg-color: #ffe6ee; --text-color: #d15c82; --card-bg: rgba(255, 255, 255, 0.95); --card-bg-self: #fff0f5; --accent: #ff9ebb; --border: #ffbad2; --bg-pattern-size: 150px; --bg-image: url('https://upload.wikimedia.org/wikipedia/en/0/05/Hello_kitty_character_portrait.png'); }
        [data-theme="chiikawa"] { --bg-color: #f0f8ff; --text-color: #4a6fa5; --card-bg: rgba(255, 255, 255, 0.95); --card-bg-self: #f0f8ff; --accent: #89c2d9; --border: #a9d6e5; --bg-pattern-size: 120px; --bg-image: url('https://talktoabutt.site/chiikawa.webp'); }
        [data-theme="dark"] { --bg-color: #0f0f0f; --text-color: #e0e0e0; --card-bg: #282828; --card-bg-self: #3a3a3a; --accent: #00ff9d; --border: #333; --bg-pattern-size: 0px; --bg-image: none; }
        [data-theme="mocha"] { --bg-color: #fdf6e3; --text-color: #586e75; --card-bg: #eee8d5; --card-bg-self: #e4dec7; --accent: #b58900; --border: #d2b48c; --bg-pattern-size: 50px; --bg-image: radial-gradient(#d2b48c 20%, transparent 20%); }
        [data-theme="midnight"] { --bg-color: #000000; --text-color: #9d9d9d; --card-bg: #1e1e1e; --card-bg-self: #2d2d2d; --accent: #6a00ff; --border: #222; --bg-pattern-size: 0px; --bg-image: none; }
        [data-theme="froggy"] { --bg-color: #e8f5e9; --text-color: #2e7d32; --card-bg: #ffffff; --card-bg-self: #dcffe0; --accent: #66bb6a; --border: #a5d6a7; --bg-pattern-size: 60px; --bg-image: url('https://talktoabutt.site/image.png'); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: var(--app-height); overflow: hidden; overscroll-behavior: none; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); transition: background 0.3s ease, color 0.3s ease; position: relative; }
        
        /* BACKGROUND ANIMATION (Optimized) */
        .bg-stickers {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--bg-image); background-size: var(--bg-pattern-size);
            background-repeat: repeat; opacity: 0.10; pointer-events: none; z-index: 0;
            will-change: transform;
            animation: float 60s linear infinite;
        }
        @keyframes float { from { background-position: 0 0; } to { background-position: 100px 100px; } }

        /* LAYOUT */
        #app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100%; max-width: 600px; margin: 0 auto; background: transparent; }
        @media (min-width: 601px) { #app { border-left: 1px solid var(--border); border-right: 1px solid var(--border); box-shadow: 0 0 50px rgba(0,0,0,0.05); } }

        /* HEADER */
        header { flex-shrink: 0; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 20; }
        h1 { margin: 0; font-size: 1.1rem; text-transform: lowercase; }
        .header-actions { display: flex; gap: 10px; }
        .btn-small { background: none; border: 1px solid var(--border); color: var(--text-color); padding: 6px 12px; border-radius: 15px; cursor: pointer; font-family: inherit; font-size: 0.75rem; transition: 0.2s; }
        .btn-small:active { transform: scale(0.95); }

        /* FEED AREA */
        #feed { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 15px; scroll-behavior: smooth; z-index: 5; }
        .log-group { margin-bottom: 30px; }
        
        /* DATE HEADER FIX */
        .date-header {
            font-size: 0.75rem; opacity: 0.9; margin-bottom: 15px; text-align: center;
            position: sticky; top: -1px; z-index: 10;
            background: var(--bg-color); 
            border-bottom: 1px solid var(--border);
            padding: 8px 0;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .entry-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 12px; position: relative; }
        .entry-container.self { align-items: flex-end; }
        .entry-container.other { align-items: flex-start; }
        .author-label { font-size: 0.65rem; margin-bottom: 3px; opacity: 0.7; margin-left: 10px; margin-right: 10px; }
        
        .entry {
            max-width: 85%; padding: 12px 16px; position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            animation: popIn 0.3s var(--ease);
            font-size: 0.95rem; line-height: 1.5; word-break: break-word;
        }
        .entry-container.self .entry { background: var(--card-bg-self); border-radius: 18px 18px 4px 18px; border: 1px solid var(--border); }
        .entry-container.other .entry { background: var(--card-bg); border-radius: 18px 18px 18px 4px; border: 1px solid var(--border); }

        .entry-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; opacity: 0.6; margin-top: 6px; gap: 8px; min-height: 16px; }
        
        /* READ RECEIPTS & ACTIONS */
        .read-status { font-size: 0.7rem; color: var(--accent); margin-left: 5px; opacity: 0.8; }
        .msg-actions { opacity: 0; transition: opacity 0.2s; display: flex; gap: 8px; }
        .entry:hover .msg-actions, .entry:active .msg-actions { opacity: 1; }
        .action-icon { cursor: pointer; font-size: 0.8rem; padding: 2px 5px; }

        .reactions-bar { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .reaction-pill { background: rgba(0,0,0,0.03); border-radius: 10px; padding: 2px 8px; font-size: 0.75rem; border: 1px solid var(--border); }
        .add-react-btn { background: none; border: none; opacity: 0.4; cursor: pointer; font-size: 0.9rem; padding: 0 5px; transition: opacity 0.2s; }
        .add-react-btn:hover { opacity: 1; }

        /* INPUT AREA */
        #input-area { flex-shrink: 0; padding: 10px 15px; padding-bottom: max(10px, env(safe-area-inset-bottom)); background: var(--card-bg); border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: center; z-index: 30; }
        #type-select { appearance: none; background: var(--bg-color); border: 1px solid var(--border); padding: 0; border-radius: 12px; font-size: 1.2rem; cursor: pointer; width: 44px; height: 44px; text-align: center; display: flex; align-items: center; justify-content: center; }
        #log-input { flex: 1; background: var(--bg-color); border: 1px solid var(--border); color: var(--text-color); padding: 12px 15px; border-radius: 22px; font-family: inherit; font-size: 1rem; outline: none; transition: border 0.2s; }
        #log-input:focus { border-color: var(--accent); }
        
        #send-btn {
            background: var(--accent); color: white; border: none; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        #send-btn:active { transform: scale(0.9); }
        #send-btn.loading { animation: spin 1s linear infinite; opacity: 0.7; pointer-events: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* MODALS */
        .overlay-screen, .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal.active, .overlay-screen.active { display: flex; }
        
        .modal-content {
            background: var(--bg-color); padding: 25px; border-radius: 20px; width: 100%; max-width: 350px;
            border: 1px solid var(--border); max-height: 85vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s var(--ease);
        }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .theme-btn { padding: 12px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 10px; color: var(--text-color); cursor: pointer; font-size: 0.9rem; text-transform: lowercase; }
        .theme-btn.active { border: 2px solid var(--accent); background: var(--card-bg-self); font-weight: bold; }

        .full-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-color); margin: 10px 0; font-family: inherit; outline: none; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-family: inherit; font-size: 1rem; margin-top: 10px; width: 100%; font-weight: bold; }
        .btn-danger { background: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-family: inherit; font-size: 0.8rem; margin-top: 5px; }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .stats-table td { padding: 10px; border-bottom: 1px solid var(--border); }
        .stat-num { text-align: right; font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body data-theme="sanrio">
    <div class="bg-stickers"></div>

    <div id="lock-screen" class="overlay-screen">
        <div style="background: var(--bg-color); padding: 40px; border-radius: 30px; text-align: center;">
            <h2 style="margin-top:0;">üîí locked</h2>
            <input type="password" id="lock-pin" class="full-input" style="text-align:center; letter-spacing: 5px; font-size: 1.5rem;" inputmode="numeric" placeholder="****">
            <button class="action-btn" onclick="checkLock()">unlock</button>
        </div>
    </div>

    <div id="setup-screen" class="overlay-screen">
        <div class="modal-content" style="text-align: center;">
            <h1>üëã welcome</h1>
            <p>what do you wanna be called...,</p>
            <input type="text" id="setup-name" class="full-input" placeholder="e.g. his beautiful angel" style="text-align:center;">
            <button class="action-btn" onclick="finishSetup()">start logging</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        <header>
            <h1>our secret thing</h1>
            <div class="header-actions">
                <button class="btn-small" onclick="calculateStats()">üìä</button>
                <button class="btn-small" onclick="toggleModal('settings')">‚öôÔ∏è</button>
            </div>
        </header>

        <div id="feed">
            <div style="text-align: center; padding: 40px; opacity: 0.5;">loading logs...</div>
        </div>

        <form id="input-area">
            <select id="type-select">
                <option value="note">üìù</option>
                <option value="food">üç±</option>
                <option value="activity">üéÆ</option>
                <option value="sleep">üí§</option>
                <option value="love">üíñ</option>
            </select>
            <input type="text" id="log-input" placeholder="say something..." autocomplete="off" required>
            <button type="submit" id="send-btn">‚ûú</button>
        </form>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>settings</h3>
                <button class="btn-small" onclick="toggleModal('settings')">close</button>
            </div>
            
            <p style="margin-top:15px; font-weight:bold; opacity:0.8;">themes</p>
            <div class="theme-grid">
                <button class="theme-btn" onclick="setTheme('sanrio')">sanrio</button>
                <button class="theme-btn" onclick="setTheme('chiikawa')">chiikawa</button>
                <button class="theme-btn" onclick="setTheme('froggy')">froggy</button>
                <button class="theme-btn" onclick="setTheme('mocha')">mocha</button>
                <button class="theme-btn" onclick="setTheme('dark')">dark</button>
                <button class="theme-btn" onclick="setTheme('midnight')">midnight</button>
            </div>

            <p style="margin-top:15px; font-weight:bold; opacity:0.8;">privacy</p>
            <input type="text" id="set-pin" class="full-input" placeholder="new pin (empty to remove)">
            <button class="btn-small" style="width:100%" onclick="savePin()">save pin</button>

            <div style="margin-top: 25px; text-align: center; padding-top: 15px; border-top: 1px solid var(--border);">
                <p style="margin: 5px 0;">logged in as: <strong id="current-user-display"></strong></p>
                <button class="btn-small" style="background:rgba(0,0,0,0.05);" onclick="resetUser()">logout / reset name</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>history</h3>
                <button class="btn-small" onclick="toggleModal('stats')">close</button>
            </div>
            <div id="stats-content"></div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>edit post</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="edit-input" class="full-input">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="action-btn" onclick="submitEdit()">save</button>
                <button class="btn-danger" onclick="toggleModal('edit')">cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ============================================
        // 1. GLOBAL UI FUNCTIONS (ATTACH TO WINDOW)
        // ============================================
        
        // Modal Toggler
        window.toggleModal = (name) => {
            const el = document.getElementById(`${name}-modal`);
            if(el) el.classList.toggle('active');
        };

        // Theme Setter
        window.setTheme = (themeName) => {
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('theme', themeName);
            // Update meta theme-color for mobile browsers
            const meta = document.querySelector('meta[name="theme-color"]');
            if(meta) {
                const computed = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
                meta.setAttribute('content', computed);
            }
            // Update UI buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.textContent.trim() === themeName) btn.classList.add('active');
            });
        };

        // User Setup Logic
        window.finishSetup = () => {
            const name = document.getElementById('setup-name').value.trim();
            if(name) { 
                localStorage.setItem('username', name); 
                location.reload(); 
            }
        };

        window.resetUser = () => {
            if(confirm("reset user name and logout?")) {
                localStorage.removeItem('username');
                location.reload();
            }
        };

        // Lock/PIN Logic
        window.savePin = () => {
            const pin = document.getElementById('set-pin').value.trim();
            if(pin === "") { 
                localStorage.removeItem('app_pin'); 
                alert("lock removed"); 
            } else { 
                localStorage.setItem('app_pin', pin); 
                alert("pin saved."); 
            }
            window.toggleModal('settings');
        };

        window.checkLock = () => {
            const input = document.getElementById('lock-pin').value;
            if(input === localStorage.getItem('app_pin')) {
                document.getElementById('lock-screen').classList.remove('active');
                if(!localStorage.getItem('username')) {
                    document.getElementById('setup-screen').classList.add('active');
                } else {
                    document.getElementById('app').style.display = 'flex';
                }
            } else {
                const pinField = document.getElementById('lock-pin');
                pinField.classList.add('shake');
                setTimeout(()=>pinField.classList.remove('shake'), 500);
                pinField.value = '';
            }
        };

        // Stats Logic
        window.calculateStats = () => {
            // Recalculate based on currently loaded logs from memory
            const stats = {};
            
            // loadedLogs is defined in scope below, accessible here? 
            // No, functions on window don't close over module scope automatically unless defined inside.
            // Since this function is defined inside the module, it captures 'loadedLogs'.
            if(!loadedLogs) return;

            loadedLogs.forEach(data => {
                const name = data.author || 'anon';
                if(!stats[name]) stats[name] = { total: 0, food: 0, activity: 0, sleep: 0, love: 0, other: 0 };
                stats[name].total++;
                if(data.type === 'food') stats[name].food++;
                else if(data.type === 'activity') stats[name].activity++;
                else if(data.type === 'sleep') stats[name].sleep++;
                else if(data.type === 'love') stats[name].love++;
                else stats[name].other++;
            });

            let html = '<table class="stats-table">';
            for(const [name, data] of Object.entries(stats)) {
                html += `
                    <tr><td colspan="2" style="background:var(--accent); color:#fff; border-radius:5px;"><strong>${name}</strong></td></tr>
                    <tr><td>total posts</td><td class="stat-num">${data.total}</td></tr>
                    <tr><td>meals üç±</td><td class="stat-num">${data.food}</td></tr>
                    <tr><td>activities üéÆ</td><td class="stat-num">${data.activity}</td></tr>
                    <tr><td>sleep üí§</td><td class="stat-num">${data.sleep}</td></tr>
                    <tr><td>love üíñ</td><td class="stat-num">${data.love}</td></tr>
                `;
            }
            html += '</table>';
            document.getElementById('stats-content').innerHTML = html;
            window.toggleModal('stats');
        };

        // Click outside modal to close
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) event.target.classList.remove('active');
        };

        // ============================================
        // 2. FIREBASE CONFIG & INIT
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAnz5Nfuooy5cyv2xqAhb79m8FDXSpMsi8",
            authDomain: "loveapp-e565a.firebaseapp.com",
            projectId: "loveapp-e565a",
            storageBucket: "loveapp-e565a.firebasestorage.app",
            messagingSenderId: "942341178242",
            appId: "1:942341178242:web:10dc0420a66d75247f459b"
        };

        let db;
        let loadedLogs = []; // State for stats and logic

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error", e);
            alert("Could not connect to database.");
        }

        // ============================================
        // 3. DATABASE OPERATIONS (ATTACH TO WINDOW)
        // ============================================

        window.reactToPost = async (id) => {
            const emoji = prompt("pick an emoji:", "‚ù§Ô∏è");
            if(emoji) {
                const docRef = doc(db, "logs", id);
                const currentUser = localStorage.getItem('username');
                const updateKey = `reactions.${currentUser}`;
                try {
                    await updateDoc(docRef, { [updateKey]: emoji });
                } catch(e) { console.error(e); }
            }
        };

        window.deletePost = async (id) => {
            if(confirm("delete this post forever?")) {
                try { await deleteDoc(doc(db, "logs", id)); } 
                catch(e) { alert("failed to delete: " + e.message); }
            }
        };

        window.openEdit = (id, content) => {
            // Need to decode HTML entities if we want to edit raw text
            const txt = document.createElement("textarea");
            txt.innerHTML = content;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-input').value = txt.value;
            window.toggleModal('edit');
            setTimeout(() => document.getElementById('edit-input').focus(), 100);
        };

        window.submitEdit = async () => {
            const id = document.getElementById('edit-id').value;
            const content = document.getElementById('edit-input').value.trim();
            if(!content) return;
            try {
                await updateDoc(doc(db, "logs", id), { content: content, isEdited: true });
                window.toggleModal('edit');
            } catch(e) { alert("update failed: " + e.message); }
        };

        // ============================================
        // 4. MAIN APPLICATION LOGIC
        // ============================================

        function initApp() {
            const feedEl = document.getElementById('feed');
            const form = document.getElementById('input-area');
            const typeSelect = document.getElementById('type-select');
            const logInput = document.getElementById('log-input');
            const sendBtn = document.getElementById('send-btn');

            // Listen for data (Limit 50 for Chromebook optimization)
            const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snapshot) => {
                const currentUser = localStorage.getItem('username');
                const grouped = {};
                const unreadIds = []; 

                loadedLogs = []; // Reset local cache

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if(!data.timestamp) return;

                    loadedLogs.push(data);
                    
                    const dateObj = data.timestamp.toDate();
                    const sortKey = dateObj.toISOString().split('T')[0]; 
                    const displayDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

                    if (!grouped[sortKey]) grouped[sortKey] = { title: displayDate, items: [] };
                    
                    const isSelf = data.author === currentUser;
                    const readBy = data.readBy || [];
                    const isRead = readBy.includes(currentUser);
                    
                    if (!isSelf && !isRead) {
                        unreadIds.push(docSnap.id);
                    }

                    const seenByOthers = readBy.filter(u => u !== currentUser).length > 0;

                    grouped[sortKey].items.push({ 
                        id: docSnap.id, 
                        ...data, 
                        time: dateObj, 
                        isSelf,
                        seenByOthers
                    });
                });

                if (unreadIds.length > 0) {
                    markAsReadBatch(unreadIds, currentUser);
                }

                renderFeed(grouped, feedEl);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const content = logInput.value.trim();
                const type = typeSelect.value;
                const author = localStorage.getItem('username');
                
                if (!content || !author) return;

                sendBtn.classList.add('loading');
                sendBtn.innerHTML = '‚è≥';
                logInput.value = '';
                logInput.blur();

                try {
                    await addDoc(collection(db, "logs"), {
                        content: content,
                        type: type,
                        author: author,
                        reactions: {},
                        readBy: [author],
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    alert("error saving: " + e.message);
                } finally {
                    sendBtn.classList.remove('loading');
                    sendBtn.innerHTML = '‚ûú';
                    if(window.innerWidth > 600) logInput.focus();
                }
            });
        }

        function markAsReadBatch(ids, user) {
            ids.forEach(id => {
                const ref = doc(db, "logs", id);
                // We just fire the update without waiting to keep UI snappy
                // Using a safe 'merge' implicit strategy
                // Read local data to append user
                const currentReadBy = loadedLogs.find(l => l.id === id)?.readBy || [];
                if(!currentReadBy.includes(user)) {
                    updateDoc(ref, { readBy: [...currentReadBy, user] }).catch(()=>{});
                }
            });
        }

        function renderFeed(grouped, container) {
            container.innerHTML = '';
            const sortedDates = Object.keys(grouped).sort().reverse();

            sortedDates.forEach(dateKey => {
                const groupData = grouped[dateKey];
                
                const dh = document.createElement('div');
                dh.className = 'date-header';
                dh.textContent = groupData.title;
                container.appendChild(dh);

                const groupDiv = document.createElement('div');
                groupDiv.className = 'log-group';

                groupData.items.forEach(item => {
                    const alignClass = item.isSelf ? 'self' : 'other';
                    const timeStr = item.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    let icon = '';
                    switch(item.type) {
                        case 'food': icon = 'üç±'; break;
                        case 'activity': icon = 'üéÆ'; break;
                        case 'sleep': icon = 'üí§'; break;
                        case 'love': icon = 'üíñ'; break;
                        default: icon = 'üìù';
                    }

                    let reactHtml = '';
                    if(item.reactions && Object.keys(item.reactions).length > 0) {
                        reactHtml = `<div class="reactions-bar">`;
                        for (const [rUser, rEmoji] of Object.entries(item.reactions)) {
                            reactHtml += `<span class="reaction-pill" title="${rUser}">${rEmoji}</span>`;
                        }
                        reactHtml += `</div>`;
                    }

                    let readStatusHtml = '';
                    if (item.isSelf) {
                        readStatusHtml = item.seenByOthers 
                            ? `<span class="read-status" title="seen">‚úì‚úì</span>` 
                            : `<span class="read-status" style="opacity:0.3">‚úì</span>`;
                    }

                    let actionsHtml = '';
                    if (item.isSelf) {
                        // Pass content carefully to avoid breaking HTML
                        const safeContent = escapeHtml(item.content);
                        actionsHtml = `
                            <div class="msg-actions">
                                <span class="action-icon" onclick="window.openEdit('${item.id}', '${safeContent}')">‚úé</span>
                                <span class="action-icon" onclick="window.deletePost('${item.id}')" style="color:var(--accent)">‚úï</span>
                            </div>
                        `;
                    }

                    const el = document.createElement('div');
                    el.className = `entry-container ${alignClass}`;
                    el.innerHTML = `
                        <div class="author-label">${escapeHtml(item.author)}</div>
                        <div class="entry">
                            <span>${icon} ${escapeHtml(item.content)} ${item.isEdited ? '<small style="opacity:0.5">(edited)</small>' : ''}</span>
                            <div class="entry-meta">
                                <div style="display:flex; align-items:center;">
                                    <span>${timeStr}</span>
                                    ${readStatusHtml}
                                </div>
                                <div style="display:flex; align-items:center;">
                                    ${actionsHtml}
                                    <button class="add-react-btn" onclick="window.reactToPost('${item.id}')">‚ò∫+</button>
                                </div>
                            </div>
                            ${reactHtml}
                        </div>
                    `;
                    groupDiv.appendChild(el);
                });
                container.appendChild(groupDiv);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }

        // ============================================
        // 5. INITIALIZATION RUN
        // ============================================
        
        // 1. Fix viewport
        const appHeight = () => { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); }
        window.addEventListener('resize', appHeight);
        appHeight();

        // 2. Set Theme
        const savedTheme = localStorage.getItem('theme') || 'sanrio';
        window.setTheme(savedTheme);

        // 3. Handle Login/Lock State
        const currentUser = localStorage.getItem('username');
        const savedPin = localStorage.getItem('app_pin');

        if (savedPin) {
            document.getElementById('lock-screen').classList.add('active');
        } else if (!currentUser) {
            document.getElementById('setup-screen').classList.add('active');
        } else {
            document.getElementById('app').style.display = 'flex';
        }

        if(currentUser) {
            document.getElementById('current-user-display').textContent = currentUser;
            initApp();
        }
    </script>
</body>
</html>
